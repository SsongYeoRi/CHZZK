name: Chzzk Live Notifier

on:
  schedule:
    # 5ë¶„ë§ˆë‹¤ ì‹¤í–‰ (UTC ê¸°ì¤€ì´ë¯€ë¡œ í•œêµ­ ì‹œê°„ê³¼ ì°¨ì´ê°€ ìˆìœ¼ë‚˜ ì£¼ê¸°ëŠ” ë™ì¼)
    - cron: '*/5 * * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ í™œì„±í™”

jobs:
  check-live:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Check Chzzk Status and Notify
        env:
          # GitHub Secretsì— ë“±ë¡í•œ ì›¹í›„í¬ URL
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          # ì•Œë¦¼ì„ ë°›ì„ ì¹˜ì§€ì§ ì±„ë„ IDë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”
          CHZZK_CHANNEL_ID: "ì—¬ê¸°ì—_ì±„ë„_ID_ì…ë ¥"
        run: |
          python - <<EOF
          import requests
          import os
          import json

          channel_id = os.environ['CHZZK_CHANNEL_ID']
          webhook_url = os.environ['DISCORD_WEBHOOK_URL']
          
          # ì¹˜ì§€ì§ API í˜¸ì¶œ
          api_url = f"api.chzzk.naver.com{channel_id}/live-status"
          response = requests.get(api_url).json()
          
          status = response.get('content', {}).get('status') # 'OPEN' ì´ë©´ ë°©ì†¡ ì¤‘
          live_title = response.get('content', {}).get('liveTitle')
          
          # ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€ë¥¼ ìœ„í•´ í˜„ì¬ ìƒíƒœë¥¼ íŒŒì¼ë¡œ ì €ì¥í•˜ëŠ” ë¡œì§ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          # ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ 'OPEN'ì¼ ë•Œ ë””ìŠ¤ì½”ë“œë¡œ ë©”ì‹œì§€ë¥¼ ì©ë‹ˆë‹¤.
          if status == 'OPEN':
              payload = {
                  "content": f"ğŸ“¢ **ì¹˜ì§€ì§ ë°©ì†¡ ì‹œì‘!**\n**ì œëª©**: {live_title}\nchzzk.naver.com{channel_id}"
              }
              requests.post(webhook_url, json=payload)
              print("ë°©ì†¡ ì¤‘: ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ")
          else:
              print("í˜„ì¬ ë°©ì†¡ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.")
          EOF
